<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="generator" content="MarkBind 3.1.1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="../../../markbind/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../markbind/css/bootstrap-vue.min.css">
    <link rel="stylesheet" href="../../../markbind/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../../../markbind/glyphicons/css/bootstrap-glyphicons.min.css">
    <link rel="stylesheet" href="../../../markbind/css/octicons.css">
    <link rel="stylesheet" href="../../../markbind/material-icons/material-icons.css">
    <link rel="stylesheet" href="../../../markbind/css/codeblock-dark.min.css"><link rel="stylesheet" href="../../../markbind/css/markbind.min.css"><script src="../../../markbind/js/polyfill.min.js"></script>
    <script src="../../../markbind/js/vue.min.js"></script>
    <script src="../../../markbind/js/markbind.min.js"></script>
    <script src="README-zh-Hans.page-vue-render.js"></script>
    <script src="../../../markbind/js/jquery.min.js"></script><link rel="stylesheet" href="https:/mazx4960.github.io/system-design-primer/plugins/markbind-plugin-anchors/markbind-plugin-anchors.css">
    
  <link rel="stylesheet" href="https://mazx4960.github.io/system-design-primer//stylesheets/main.css">
</head>
<script>
  const baseUrl = 'https://mazx4960.github.io/system-design-primer/'
</script>
<body >
<div id="app" data-server-rendered="true"><header fixed=""><div data-v-15113a2f><nav class="navbar navbar-expand-md navbar-dark bg-dark" data-v-15113a2f><div class="container-fluid" data-v-15113a2f><div class="navbar-left" data-v-15113a2f><a href="https://mazx4960.github.io/system-design-primer//index.html" title="Home" class="navbar-brand" data-v-15113a2f>System Design Primer</a></div> <div class="navbar-default" data-v-15113a2f><ul class="navbar-nav mr-auto mt-2 mt-lg-0" data-v-15113a2f> <li class="nav-link dropdown" data-v-2e98b3f0><a role="button" class="dropdown-toggle" data-v-2e98b3f0>Solutions</a> <ul class="dropdown-menu" data-v-2e98b3f0> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/mint/readme.html" class="dropdown-item" data-v-2e98b3f0>mint</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/pastebin/readme.html" class="dropdown-item" data-v-2e98b3f0>pastebin</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/query_cache/readme.html" class="dropdown-item" data-v-2e98b3f0>query_cache</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/sales_rank/readme.html" class="dropdown-item" data-v-2e98b3f0>sales_rank</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/scaling_aws/readme.html" class="dropdown-item" data-v-2e98b3f0>scaling_aws</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/social_graph/readme.html" class="dropdown-item" data-v-2e98b3f0>social_graph</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/twitter/readme.html" class="dropdown-item" data-v-2e98b3f0>twitter</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/web_crawler/readme.html" class="dropdown-item" data-v-2e98b3f0>web_crawler</a></li></ul></li></ul></div> <ul class="navbar-nav navbar-right" data-v-15113a2f><li data-v-15113a2f><form class="navbar-form" data-v-15113a2f><div style="position:relative;"><input type="text" placeholder="Search" autocomplete="off" value="" class="form-control"> <ul class="dropdown-menu search-dropdown-menu dropdown-menu-right"></ul></div></form></li></ul></div></nav> <div class="lower-navbar-container" style="display:none;" data-v-15113a2f><!----> <!----></div></div></header> <div id="flex-body"><nav id="site-nav" class="fixed-header-padding" data-v-e8c82f88><div class="site-nav-top" data-v-e8c82f88><div class="font-weight-bold mb-2" style="font-size:1.25rem;" data-v-e8c82f88>Topics</div></div> <div class="nav-component slim-scroll" data-v-e8c82f88><div class="site-nav-root"><ul class="site-nav-list site-nav-list-root" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Preface

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Motivation.html" data-v-e8c82f88>Motivation</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Ankiflashcards.html" data-v-e8c82f88>Anki flashcards</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Indexof-system-design-topics.html" data-v-e8c82f88>Index</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Studyguide.html" data-v-e8c82f88>Study Guide</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Interview Questions

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Howto-approach-a-system-design-interview-question.html" data-v-e8c82f88>How to approach a system design interview question</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Object-orienteddesign-interview-questions-with-solutions.html" data-v-e8c82f88>OOP interview questions</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Systemdesign-interview-questions-with-solutions.html" data-v-e8c82f88>System design interview questions</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Systemdesign-topics-start-here.html" data-v-e8c82f88>System design topics</a> <i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Performancevs-scalability.html" data-v-e8c82f88>Performance vs scalability</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Latencyvs-throughput.html" data-v-e8c82f88>Latency vs throughput</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Availabilityvs-consistency.html" data-v-e8c82f88>Availability vs consistency</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Consistencypatterns.html" data-v-e8c82f88>Consistency patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Availabilitypatterns.html" data-v-e8c82f88>Availability patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Domainname-system.html" data-v-e8c82f88>Domain name system</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contentdelivery-network.html" data-v-e8c82f88>Content delivery network</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Loadbalancer.html" data-v-e8c82f88>Load balancer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Reverseproxy-(web-server).html" data-v-e8c82f88>Reverse proxy (web server)</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Applicationlayer.html" data-v-e8c82f88>Application layer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Database.html" data-v-e8c82f88>Database</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Cache.html" data-v-e8c82f88>Cache</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Asynchronism.html" data-v-e8c82f88>Asynchronism</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Communication.html" data-v-e8c82f88>Communication</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Security.html" data-v-e8c82f88>Security</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Misc

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Appendix.html" data-v-e8c82f88>Appendix</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Underdevelopment.html" data-v-e8c82f88>Under development</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Credits.html" data-v-e8c82f88>Credits</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contactinfo.html" data-v-e8c82f88>Contact info</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contributing.html" data-v-e8c82f88>Contributing</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/License.html" data-v-e8c82f88>License</a></div></li></ul></li> <!----></ul></div></div> <!----></nav> <div id="content-wrapper" class="fixed-header-padding"><h1 id="amazon"><span id="amazon" class="anchor"></span>为 Amazon 设计分类售卖排行<a href="#amazon" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h1> <p><strong>注意：这个文档中的链接会直接指向<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题索引</a>中的有关部分，以避免重复的内容。你可以参考链接的相关内容，来了解其总的要点、方案的权衡取舍以及可选的替代方案。</strong></p> <h2 id="">第一步：简述用例与约束条件</h2> <blockquote><p>搜集需求与问题的范围。
提出问题来明确用例与约束条件。
讨论假设。</p></blockquote> <p>我们将在没有面试官明确说明问题的情况下，自己定义一些用例以及限制条件。</p> <h3 id="-2"><span id="-2" class="anchor"></span>用例<a href="#-2" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="-3"><span id="-3" class="anchor"></span>我们将把问题限定在仅处理以下用例的范围中<a href="#-3" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><strong>服务</strong>根据分类计算过去一周中最受欢迎的商品</li> <li><strong>用户</strong>通过分类浏览过去一周中最受欢迎的商品</li> <li><strong>服务</strong>有着高可用性</li></ul> <h4 id="-4"><span id="-4" class="anchor"></span>不在用例范围内的有<a href="#-4" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li>一般的电商网站
<ul><li>只为售卖排行榜设计组件</li></ul></li></ul> <h3 id="-5"><span id="-5" class="anchor"></span>限制条件与假设<a href="#-5" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="-6"><span id="-6" class="anchor"></span>提出假设<a href="#-6" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li>网络流量不是均匀分布的</li> <li>一个商品可能存在于多个分类中</li> <li>商品不能够更改分类</li> <li>不会存在如 <code class="hljs inline no-lang">foo/bar/baz</code> 之类的子分类</li> <li>每小时更新一次结果
<ul><li>受欢迎的商品越多，就需要更频繁地更新</li></ul></li> <li>1000 万个商品</li> <li>1000 个分类</li> <li>每个月 10 亿次交易</li> <li>每个月 1000 亿次读取请求</li> <li>100:1 的读写比例</li></ul> <h4 id="-7"><span id="-7" class="anchor"></span>计算用量<a href="#-7" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p><strong>如果你需要进行粗略的用量计算，请向你的面试官说明。</strong></p> <ul><li>每笔交易的用量：
<ul><li><code class="hljs inline no-lang">created_at</code> - 5 字节</li> <li><code class="hljs inline no-lang">product_id</code> - 8 字节</li> <li><code class="hljs inline no-lang">category_id</code> - 4 字节</li> <li><code class="hljs inline no-lang">seller_id</code> - 8 字节</li> <li><code class="hljs inline no-lang">buyer_id</code> - 8 字节</li> <li><code class="hljs inline no-lang">quantity</code> - 4 字节</li> <li><code class="hljs inline no-lang">total_price</code> - 5 字节</li> <li>总计：大约 40 字节</li></ul></li> <li>每个月的交易内容会产生 40 GB 的记录
<ul><li>每次交易 40 字节 * 每个月 10 亿次交易</li> <li>3年内产生了 1.44 TB 的新交易内容记录</li> <li>假定大多数的交易都是新交易而不是更改以前进行完的交易</li></ul></li> <li>平均每秒 400 次交易次数</li> <li>平均每秒 40,000 次读取请求</li></ul> <p>便利换算指南：</p> <ul><li>每个月有 250 万秒</li> <li>每秒一个请求 = 每个月 250 万次请求</li> <li>每秒 40 个请求 = 每个月 1 亿次请求</li> <li>每秒 400 个请求 = 每个月 10 亿次请求</li></ul> <h2 id="-8"><span id="-8" class="anchor"></span>第二步：概要设计<a href="#-8" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>列出所有重要组件以规划概要设计。</p></blockquote> <p><a href="http://i.imgur.com/vwMa1Qu.png" target="_self"><img src="http://i.imgur.com/vwMa1Qu.png" alt="" class="img-fluid"></a></p> <h2 id="-9"><span id="-9" class="anchor"></span>第三步：设计核心组件<a href="#-9" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>深入每个核心组件的细节。</p></blockquote> <h3 id="-10"><span id="-10" class="anchor"></span>用例：服务需要根据分类计算上周最受欢迎的商品<a href="#-10" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>我们可以在现成的<strong>对象存储</strong>系统（例如 Amazon S3 服务）中存储 <strong>售卖 API</strong> 服务产生的日志文本， 因此不需要我们自己搭建分布式文件系统了。</p> <p><strong>向你的面试官告知你准备写多少代码</strong>。</p> <p>假设下面是一个用 tab 分割的简易的日志记录：</p> <pre><code class="hljs"><span>timestamp   product_id  category_id    qty     total_price   seller_id    buyer_id
</span><span>t1          product1    category1      2       20.00         1            1
</span><span>t2          product1    category2      2       20.00         2            2
</span><span>t2          product1    category2      1       10.00         2            3
</span><span>t3          product2    category1      3        7.00         3            4
</span><span>t4          product3    category2      7        2.00         4            5
</span><span>t5          product4    category1      1        5.00         5            6
</span><span>...
</span></code></pre><p><strong>售卖排行服务</strong> 需要用到 <strong>MapReduce</strong>，并使用 <strong>售卖 API</strong> 服务进行日志记录，同时将结果写入 <strong>SQL 数据库</strong>中的总表 <code class="hljs inline no-lang">sales_rank</code> 中。我们也可以讨论一下<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">究竟是用 SQL 还是用 NoSQL</a>。</p> <p>我们需要通过以下步骤使用 <strong>MapReduce</strong>：</p> <ul><li><strong>第 1 步</strong> - 将数据转换为 <code class="hljs inline no-lang">(category, product_id), sum(quantity)</code> 的形式</li> <li><strong>第 2 步</strong> - 执行分布式排序</li></ul> <pre><code class="hljs python"><span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SalesRanker</span>(<span class="hljs-params">MRJob</span>):</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">within_past_week</span>(<span class="hljs-params">self, timestamp</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;如果时间戳属于过去的一周则返回 True，</span>
</span><span><span class="hljs-string">        否则返回 False。&quot;&quot;&quot;</span>
</span><span>        ...
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mapper</span>(<span class="hljs-params">self, _ line</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;解析日志的每一行，提取并转换相关行，</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        将键值对设定为如下形式：</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        (category1, product1), 2</span>
</span><span><span class="hljs-string">        (category2, product1), 2</span>
</span><span><span class="hljs-string">        (category2, product1), 1</span>
</span><span><span class="hljs-string">        (category1, product2), 3</span>
</span><span><span class="hljs-string">        (category2, product3), 7</span>
</span><span><span class="hljs-string">        (category1, product4), 1</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        timestamp, product_id, category_id, quantity, total_price, seller_id, \
</span><span>            buyer_id = line.split(<span class="hljs-string">'\t'</span>)
</span><span>        <span class="hljs-keyword">if</span> self.within_past_week(timestamp):
</span><span>            <span class="hljs-keyword">yield</span> (category_id, product_id), quantity
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reducer</span>(<span class="hljs-params">self, key, value</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;将每个 key 的值加起来。</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        (category1, product1), 2</span>
</span><span><span class="hljs-string">        (category2, product1), 3</span>
</span><span><span class="hljs-string">        (category1, product2), 3</span>
</span><span><span class="hljs-string">        (category2, product3), 7</span>
</span><span><span class="hljs-string">        (category1, product4), 1</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        <span class="hljs-keyword">yield</span> key, <span class="hljs-built_in">sum</span>(values)
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mapper_sort</span>(<span class="hljs-params">self, key, value</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;构造 key 以确保正确的排序。</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        将键值对转换成如下形式：</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        (category1, 2), product1</span>
</span><span><span class="hljs-string">        (category2, 3), product1</span>
</span><span><span class="hljs-string">        (category1, 3), product2</span>
</span><span><span class="hljs-string">        (category2, 7), product3</span>
</span><span><span class="hljs-string">        (category1, 1), product4</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        MapReduce 的随机排序步骤会将键</span>
</span><span><span class="hljs-string">        值的排序打乱，变成下面这样：</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        (category1, 1), product4</span>
</span><span><span class="hljs-string">        (category1, 2), product1</span>
</span><span><span class="hljs-string">        (category1, 3), product2</span>
</span><span><span class="hljs-string">        (category2, 3), product1</span>
</span><span><span class="hljs-string">        (category2, 7), product3</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        category_id, product_id = key
</span><span>        quantity = value
</span><span>        <span class="hljs-keyword">yield</span> (category_id, quantity), product_id
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reducer_identity</span>(<span class="hljs-params">self, key, value</span>):</span>
</span><span>        <span class="hljs-keyword">yield</span> key, value
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">steps</span>(<span class="hljs-params">self</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot; 此处为 map reduce 步骤&quot;&quot;&quot;</span>
</span><span>        <span class="hljs-keyword">return</span> [
</span><span>            self.mr(mapper=self.mapper,
</span><span>                    reducer=self.reducer),
</span><span>            self.mr(mapper=self.mapper_sort,
</span><span>                    reducer=self.reducer_identity),
</span><span>        ]
</span></code></pre><p>得到的结果将会是如下的排序列，我们将其插入 <code class="hljs inline no-lang">sales_rank</code> 表中：</p> <pre><code class="hljs"><span>(category1, 1), product4
</span><span>(category1, 2), product1
</span><span>(category1, 3), product2
</span><span>(category2, 3), product1
</span><span>(category2, 7), product3
</span></code></pre><p><code class="hljs inline no-lang">sales_rank</code> 表的数据结构如下：</p> <pre><code class="hljs"><span>id int NOT NULL AUTO_INCREMENT
</span><span>category_id int NOT NULL
</span><span>total_sold int NOT NULL
</span><span>product_id int NOT NULL
</span><span>PRIMARY KEY(id)
</span><span>FOREIGN KEY(category_id) REFERENCES Categories(id)
</span><span>FOREIGN KEY(product_id) REFERENCES Products(id)
</span></code></pre><p>我们会以 <code class="hljs inline no-lang">id</code>、<code class="hljs inline no-lang">category_id</code> 与 <code class="hljs inline no-lang">product_id</code> 创建一个 <a href="https://github.com/donnemartin/system-design-primer#use-good-indices">索引</a>以加快查询速度（只需要使用读取日志的时间，不再需要每次都扫描整个数据表）并让数据常驻内存。从内存读取 1 MB 连续数据大约要花 250 微秒，而从 SSD 读取同样大小的数据要花费 4 倍的时间，从机械硬盘读取需要花费 80 倍以上的时间。<sup><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#每个程序员都应该知道的延迟数">1</a></sup></p> <h3 id="-11"><span id="-11" class="anchor"></span>用例：用户需要根据分类浏览上周中最受欢迎的商品<a href="#-11" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><strong>客户端</strong>向运行<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理</a>的 <strong>Web 服务器</strong>发送一个请求</li> <li>这个 <strong>Web 服务器</strong>将请求转发给<strong>查询 API</strong> 服务</li> <li>The <strong>查询 API</strong> 服务将从 <strong>SQL 数据库</strong>的 <code class="hljs inline no-lang">sales_rank</code> 表中读取数据</li></ul> <p>我们可以调用一个公共的 <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">REST API</a>：</p> <pre><code class="hljs"><span>$ curl https://amazon.com/api/v1/popular?category_id=1234
</span></code></pre><p>返回：</p> <pre><code class="hljs"><span>{
</span><span>    &quot;id&quot;: &quot;100&quot;,
</span><span>    &quot;category_id&quot;: &quot;1234&quot;,
</span><span>    &quot;total_sold&quot;: &quot;100000&quot;,
</span><span>    &quot;product_id&quot;: &quot;50&quot;,
</span><span>},
</span><span>{
</span><span>    &quot;id&quot;: &quot;53&quot;,
</span><span>    &quot;category_id&quot;: &quot;1234&quot;,
</span><span>    &quot;total_sold&quot;: &quot;90000&quot;,
</span><span>    &quot;product_id&quot;: &quot;200&quot;,
</span><span>},
</span><span>{
</span><span>    &quot;id&quot;: &quot;75&quot;,
</span><span>    &quot;category_id&quot;: &quot;1234&quot;,
</span><span>    &quot;total_sold&quot;: &quot;80000&quot;,
</span><span>    &quot;product_id&quot;: &quot;3&quot;,
</span><span>},
</span></code></pre><p>而对于服务器内部的通信，我们可以使用 <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a>。</p> <h2 id="-12"><span id="-12" class="anchor"></span>第四步：架构扩展<a href="#-12" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>根据限制条件，找到并解决瓶颈。</p></blockquote> <p><a href="http://i.imgur.com/MzExP06.png" target="_self"><img src="http://i.imgur.com/MzExP06.png" alt="" class="img-fluid"></a></p> <p><strong>重要提示：不要从最初设计直接跳到最终设计中！</strong></p> <p>现在你要 1) <strong>基准测试、负载测试</strong>。2) <strong>分析、描述</strong>性能瓶颈。3) 在解决瓶颈问题的同时，评估替代方案、权衡利弊。4) 重复以上步骤。请阅读<a href="/mazx4960.github.io/system-design-primer/solutions/system_design/scaling_aws/README.html">「设计一个系统，并将其扩大到为数以百万计的 AWS 用户服务」</a> 来了解如何逐步扩大初始设计。</p> <p>讨论初始设计可能遇到的瓶颈及相关解决方案是很重要的。例如加上一个配置多台 <strong>Web 服务器</strong>的<strong>负载均衡器</strong>是否能够解决问题？<strong>CDN</strong>呢？<strong>主从复制</strong>呢？它们各自的替代方案和需要<strong>权衡</strong>的利弊又有什么呢？</p> <p>我们将会介绍一些组件来完成设计，并解决架构扩张问题。内置的负载均衡器将不做讨论以节省篇幅。</p> <p><strong>为了避免重复讨论</strong>，请参考<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题索引</a>相关部分来了解其要点、方案的权衡取舍以及可选的替代方案。</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F">DNS</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">负载均衡器</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95">水平拓展</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理（web 服务器）</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E5%B1%82">API 服务（应用层）</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98">缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Frdbms">关系型数据库管理系统 (RDBMS)</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2">SQL 故障主从切换</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%BC%8F">一致性模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F">可用性模式</a></li></ul> <p><strong>分析数据库</strong> 可以用现成的数据仓储系统，例如使用 Amazon Redshift 或者 Google BigQuery 的解决方案。</p> <p>当使用数据仓储技术或者<strong>对象存储</strong>系统时，我们只想在数据库中存储有限时间段的数据。Amazon S3 的<strong>对象存储</strong>系统可以很方便地设置每个月限制只允许新增 40 GB 的存储内容。</p> <p>平均每秒 40,000 次的读取请求（峰值将会更高）, 可以通过扩展 <strong>内存缓存</strong> 来处理热点内容的读取流量，这对于处理不均匀分布的流量和流量峰值也很有用。由于读取量非常大，<strong>SQL Read 副本</strong> 可能会遇到处理缓存未命中的问题，我们可能需要使用额外的 SQL 扩展模式。</p> <p>平均每秒 400 次写操作（峰值将会更高）可能对于单个 <strong>SQL 写主-从</strong> 模式来说比较很困难，因此同时还需要更多的扩展技术</p> <p>SQL 缩放模式包括：</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96">非规范化</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%B0%83%E4%BC%98">SQL 调优</a></li></ul> <p>我们也可以考虑将一些数据移至 <strong>NoSQL 数据库</strong>。</p> <h2 id="-13"><span id="-13" class="anchor"></span>其它要点<a href="#-13" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>是否深入这些额外的主题，取决于你的问题范围和剩下的时间。</p></blockquote> <h4 id="nosql"><span id="nosql" class="anchor"></span>NoSQL<a href="#nosql" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">键-值存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">文档类型存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8">列型存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93">图数据库</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">SQL vs NoSQL</a></li></ul> <h3 id="-14"><span id="-14" class="anchor"></span>缓存<a href="#-14" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>在哪缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98">客户端缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E7%BC%93%E5%AD%98">CDN 缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98">Web 服务器缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98">数据库缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98">应用缓存</a></li></ul></li> <li>什么需要缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">数据库查询级别的缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">对象级别的缓存</a></li></ul></li> <li>何时更新缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F">直写模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F">回写模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%B7%E6%96%B0">刷新</a></li></ul></li></ul> <h3 id="-15"><span id="-15" class="anchor"></span>异步与微服务<a href="#-15" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97">任务队列</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%83%8C%E5%8E%8B">背压</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a></li></ul> <h3 id="-16"><span id="-16" class="anchor"></span>通信<a href="#-16" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>可权衡选择的方案：
<ul><li>与客户端的外部通信 - <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">使用 REST 作为 HTTP API</a></li> <li>服务器内部通信 - <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a></li></ul></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li></ul> <h3 id="-17"><span id="-17" class="anchor"></span>安全性<a href="#-17" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>请参阅<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%89%E5%85%A8">「安全」</a>一章。</p> <h3 id="-18"><span id="-18" class="anchor"></span>延迟数值<a href="#-18" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>请参阅<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AF%8F%E4%B8%AA%E7%A8%8B%E5%BA%8F%E5%91%98%E9%83%BD%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%95%B0">「每个程序员都应该知道的延迟数」</a>。</p> <h3 id="-19"><span id="-19" class="anchor"></span>持续探讨<a href="#-19" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>持续进行基准测试并监控你的系统，以解决他们提出的瓶颈问题。</li> <li>架构拓展是一个迭代的过程。</li></ul> <i id="scroll-top-button" onclick="handleScrollTop()" aria-hidden="true" class="fa fa-arrow-circle-up fa-lg d-print-none"></i></div> <nav id="page-nav" class="fixed-header-padding" data-v-e8c82f88><div class="nav-component slim-scroll" data-v-e8c82f88></div> <!----></nav></div> <footer><div class="text-center"><small>[Generated by <a href="https://markbind.org/">MarkBind 3.1.1</a>]</small></div></footer></div>
</body><script src="../../../markbind/js/bootstrap-utility.min.js"></script>
<script>
  MarkBind.setupWithSearch()
</script>
</html>
