<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="generator" content="MarkBind 3.1.1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="../../../markbind/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../markbind/css/bootstrap-vue.min.css">
    <link rel="stylesheet" href="../../../markbind/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../../../markbind/glyphicons/css/bootstrap-glyphicons.min.css">
    <link rel="stylesheet" href="../../../markbind/css/octicons.css">
    <link rel="stylesheet" href="../../../markbind/material-icons/material-icons.css">
    <link rel="stylesheet" href="../../../markbind/css/codeblock-dark.min.css"><link rel="stylesheet" href="../../../markbind/css/markbind.min.css"><script src="../../../markbind/js/polyfill.min.js"></script>
    <script src="../../../markbind/js/vue.min.js"></script>
    <script src="../../../markbind/js/markbind.min.js"></script>
    <script src="README-zh-Hans.page-vue-render.js"></script>
    <script src="../../../markbind/js/jquery.min.js"></script><link rel="stylesheet" href="/plugins/markbind-plugin-anchors/markbind-plugin-anchors.css">
    
  <link rel="stylesheet" href="/stylesheets/main.css">
</head>
<script>
  const baseUrl = ''
</script>
<body >
<div id="app" data-server-rendered="true"><header fixed=""><div data-v-15113a2f><nav class="navbar navbar-expand-md navbar-dark bg-dark" data-v-15113a2f><div class="container-fluid" data-v-15113a2f><div class="navbar-left" data-v-15113a2f><a href="/index.html" title="Home" class="navbar-brand" data-v-15113a2f>System Design Primer</a></div> <div class="navbar-default" data-v-15113a2f><ul class="navbar-nav mr-auto mt-2 mt-lg-0" data-v-15113a2f> <li class="nav-link dropdown" data-v-2e98b3f0><a role="button" class="dropdown-toggle" data-v-2e98b3f0>Solutions</a> <ul class="dropdown-menu" data-v-2e98b3f0> <li data-v-2e98b3f0><a href="/solutions/system_design/mint/readme.html" class="dropdown-item" data-v-2e98b3f0>mint</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/pastebin/readme.html" class="dropdown-item" data-v-2e98b3f0>pastebin</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/query_cache/readme.html" class="dropdown-item" data-v-2e98b3f0>query_cache</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/sales_rank/readme.html" class="dropdown-item" data-v-2e98b3f0>sales_rank</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/scaling_aws/readme.html" class="dropdown-item" data-v-2e98b3f0>scaling_aws</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/social_graph/readme.html" class="dropdown-item" data-v-2e98b3f0>social_graph</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/twitter/readme.html" class="dropdown-item" data-v-2e98b3f0>twitter</a></li> <li data-v-2e98b3f0><a href="/solutions/system_design/web_crawler/readme.html" class="dropdown-item" data-v-2e98b3f0>web_crawler</a></li></ul></li></ul></div> <ul class="navbar-nav navbar-right" data-v-15113a2f><li data-v-15113a2f><form class="navbar-form" data-v-15113a2f><div style="position:relative;"><input type="text" placeholder="Search" autocomplete="off" value="" class="form-control"> <ul class="dropdown-menu search-dropdown-menu dropdown-menu-right"></ul></div></form></li></ul></div></nav> <div class="lower-navbar-container" style="display:none;" data-v-15113a2f><!----> <!----></div></div></header> <div id="flex-body"><nav id="site-nav" class="fixed-header-padding" data-v-e8c82f88><div class="site-nav-top" data-v-e8c82f88><div class="font-weight-bold mb-2" style="font-size:1.25rem;" data-v-e8c82f88>Topics</div></div> <div class="nav-component slim-scroll" data-v-e8c82f88><div class="site-nav-root"><ul class="site-nav-list site-nav-list-root" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Preface

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Motivation.html" data-v-e8c82f88>Motivation</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Ankiflashcards.html" data-v-e8c82f88>Anki flashcards</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Indexof-system-design-topics.html" data-v-e8c82f88>Index</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Studyguide.html" data-v-e8c82f88>Study Guide</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Interview Questions

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Howto-approach-a-system-design-interview-question.html" data-v-e8c82f88>How to approach a system design interview question</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Object-orienteddesign-interview-questions-with-solutions.html" data-v-e8c82f88>OOP interview questions</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Systemdesign-interview-questions-with-solutions.html" data-v-e8c82f88>System design interview questions</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88><a href="/contents/Systemdesign-topics-start-here.html" data-v-e8c82f88>System design topics</a> <i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Performancevs-scalability.html" data-v-e8c82f88>Performance vs scalability</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Latencyvs-throughput.html" data-v-e8c82f88>Latency vs throughput</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Availabilityvs-consistency.html" data-v-e8c82f88>Availability vs consistency</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Consistencypatterns.html" data-v-e8c82f88>Consistency patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Availabilitypatterns.html" data-v-e8c82f88>Availability patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Domainname-system.html" data-v-e8c82f88>Domain name system</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Contentdelivery-network.html" data-v-e8c82f88>Content delivery network</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Loadbalancer.html" data-v-e8c82f88>Load balancer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Reverseproxy-(web-server).html" data-v-e8c82f88>Reverse proxy (web server)</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Applicationlayer.html" data-v-e8c82f88>Application layer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Database.html" data-v-e8c82f88>Database</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Cache.html" data-v-e8c82f88>Cache</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Asynchronism.html" data-v-e8c82f88>Asynchronism</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Communication.html" data-v-e8c82f88>Communication</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Security.html" data-v-e8c82f88>Security</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Misc

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Appendix.html" data-v-e8c82f88>Appendix</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Underdevelopment.html" data-v-e8c82f88>Under development</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Credits.html" data-v-e8c82f88>Credits</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Contactinfo.html" data-v-e8c82f88>Contact info</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/Contributing.html" data-v-e8c82f88>Contributing</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="/contents/License.html" data-v-e8c82f88>License</a></div></li></ul></li> <!----></ul></div></div> <!----></nav> <div id="content-wrapper" class="fixed-header-padding"><h1 id="pastebin-com-bit-ly"><span id="pastebin-com-bit-ly" class="anchor"></span>设计 <a href="http://Pastebin.com">Pastebin.com</a> (或者 <a href="http://Bit.ly">Bit.ly</a>)<a href="#pastebin-com-bit-ly" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h1> <p><strong>注意: 为了避免重复，当前文档会直接链接到<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题</a>的相关区域，请参考链接内容以获得综合的讨论点、权衡和替代方案。</strong></p> <p><strong>设计 <a href="http://Bit.ly">Bit.ly</a></strong> - 是一个类似的问题，区别是 pastebin 需要存储的是 paste 的内容，而不是原始的未短化的 url。</p> <h2 id="">第一步：概述用例和约束</h2> <blockquote><p>收集这个问题的需求和范畴。
问相关问题来明确用例和约束。
讨论一些假设。</p></blockquote> <p>因为没有面试官来明确这些问题，所以我们自己将定义一些用例和约束。</p> <h3 id="-2"><span id="-2" class="anchor"></span>用例<a href="#-2" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="-3"><span id="-3" class="anchor"></span>我们将问题的范畴限定在如下用例<a href="#-3" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><strong>用户</strong> 输入一段文本，然后得到一个随机生成的链接
<ul><li>过期设置
<ul><li>默认的设置是不会过期的</li> <li>可以选择设置一个过期的时间</li></ul></li></ul></li> <li><strong>用户</strong> 输入一个 paste 的 url 后，可以看到它存储的内容</li> <li><strong>用户</strong> 是匿名的</li> <li><strong>Service</strong> 跟踪页面分析
<ul><li>一个月的访问统计</li></ul></li> <li><strong>Service</strong> 删除过期的 pastes</li> <li><strong>Service</strong> 需要高可用</li></ul> <h4 id="-4"><span id="-4" class="anchor"></span>超出范畴的用例<a href="#-4" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><strong>用户</strong> 可以注册一个账户
<ul><li><strong>用户</strong> 通过验证邮箱</li></ul></li> <li><strong>用户</strong> 可以用注册的账户登录
<ul><li><strong>用户</strong> 可以编辑文档</li></ul></li> <li><strong>用户</strong> 可以设置可见性</li> <li><strong>用户</strong> 可以设置短链接</li></ul> <h3 id="-5"><span id="-5" class="anchor"></span>约束和假设<a href="#-5" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="-6"><span id="-6" class="anchor"></span>状态假设<a href="#-6" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li>访问流量不是均匀分布的</li> <li>打开一个短链接应该是很快的</li> <li>pastes 只能是文本</li> <li>页面访问分析数据可以不用实时</li> <li>一千万的用户量</li> <li>每个月一千万的 paste 写入量</li> <li>每个月一亿的 paste 读取量</li> <li>读写比例在 10:1</li></ul> <h4 id="-7"><span id="-7" class="anchor"></span>计算使用<a href="#-7" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p><strong>向面试官说明你是否应该粗略计算一下使用情况。</strong></p> <ul><li>每个 paste 的大小
<ul><li>每一个 paste 1 KB</li> <li><code class="hljs inline no-lang">shortlink</code> - 7 bytes</li> <li><code class="hljs inline no-lang">expiration_length_in_minutes</code> - 4 bytes</li> <li><code class="hljs inline no-lang">created_at</code> - 5 bytes</li> <li><code class="hljs inline no-lang">paste_path</code> - 255 bytes</li> <li>总共 = ~1.27 KB</li></ul></li> <li>每个月新的 paste 内容在 12.7GB
<ul><li>(1.27 * 10000000)KB / 月的 paste</li> <li>三年内将近 450GB 的新 paste 内容</li> <li>三年内 3.6 亿短链接</li> <li>假设大部分都是新的 paste，而不是需要更新已存在的 paste</li></ul></li> <li>平均 4paste/s 的写入速度</li> <li>平均 40paste/s 的读取速度</li></ul> <p>简单的转换指南:</p> <ul><li>2.5 百万 req/s</li> <li>1 req/s = 2.5 百万 req/m</li> <li>40 req/s = 1 亿 req/m</li> <li>400 req/s = 10 亿 req/m</li></ul> <h2 id="-8"><span id="-8" class="anchor"></span>第二步：创建一个高层次设计<a href="#-8" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>概述一个包括所有重要的组件的高层次设计</p></blockquote> <p><a href="http://i.imgur.com/BKsBnmG.png" target="_self"><img src="http://i.imgur.com/BKsBnmG.png" alt="" class="img-fluid"></a></p> <h2 id="-9"><span id="-9" class="anchor"></span>第三步：设计核心组件<a href="#-9" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>深入每一个核心组件的细节</p></blockquote> <h3 id="-10"><span id="-10" class="anchor"></span>用例：用户输入一段文本，然后得到一个随机生成的链接<a href="#-10" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>我们可以用一个 <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Frdbms">关系型数据库</a>作为一个大的哈希表，用来把生成的 url 映射到一个包含 paste 文件的文件服务器和路径上。</p> <p>为了避免托管一个文件服务器，我们可以用一个托管的<strong>对象存储</strong>，比如 Amazon 的 S3 或者<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">NoSQL 文档类型存储</a>。</p> <p>作为一个大的哈希表的关系型数据库的替代方案，我们可以用<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">NoSQL 键值存储</a>。我们需要讨论<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">选择 SQL 或 NoSQL 之间的权衡</a>。下面的讨论是使用关系型数据库方法。</p> <ul><li><strong>客户端</strong> 发送一个创建 paste 的请求到作为一个<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理</a>启动的 <strong>Web 服务器</strong>。</li> <li><strong>Web 服务器</strong> 转发请求给 <strong>写接口</strong> 服务器</li> <li><strong>写接口</strong> 服务器执行如下操作：
<ul><li>生成一个唯一的 url
<ul><li>检查这个 url 在 <strong>SQL 数据库</strong> 里面是否是唯一的</li> <li>如果这个 url 不是唯一的，生成另外一个 url</li> <li>如果我们支持自定义 url，我们可以使用用户提供的 url（也需要检查是否重复）</li></ul></li> <li>把生成的 url 存储到 <strong>SQL 数据库</strong> 的 <code class="hljs inline no-lang">pastes</code> 表里面</li> <li>存储 paste 的内容数据到 <strong>对象存储</strong> 里面</li> <li>返回生成的 url</li></ul></li></ul> <p><strong>向面试官阐明你需要写多少代码</strong></p> <p><code class="hljs inline no-lang">pastes</code> 表可以有如下结构：</p> <pre><code class="hljs sql"><span>shortlink <span class="hljs-type">char</span>(<span class="hljs-number">7</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
</span><span>expiration_length_in_minutes <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
</span><span>created_at datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
</span><span>paste_path <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
</span><span><span class="hljs-keyword">PRIMARY</span> KEY(shortlink)
</span></code></pre><p>我们将在 <code class="hljs inline no-lang">shortlink</code> 字段和 <code class="hljs inline no-lang">created_at</code> 字段上创建一个<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BD%BF%E7%94%A8%E6%AD%A3%E7%A1%AE%E7%9A%84%E7%B4%A2%E5%BC%95">数据库索引</a>，用来提高查询的速度（避免因为扫描全表导致的长时间查询）并将数据保存在内存中，从内存里面顺序读取 1MB 的数据需要大概 250 微秒，而从 SSD 上读取则需要花费 4 倍的时间，从硬盘上则需要花费 80 倍的时间。<sup><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#每个程序员都应该知道的延迟数"> 1</a></sup></p> <p>为了生成唯一的 url，我们可以：</p> <ul><li>使用 <a href="https://en.wikipedia.org/wiki/MD5"><strong>MD5</strong></a> 来哈希用户的 IP 地址 + 时间戳
<ul><li>MD5 是一个普遍用来生成一个 128-bit 长度的哈希值的一种哈希方法</li> <li>MD5 是一致分布的</li> <li>或者我们也可以用 MD5 哈希一个随机生成的数据</li></ul></li> <li>用 <a href="https://www.kerstner.at/2012/07/shortening-strings-using-base-62-encoding/"><strong>Base 62</strong></a> 编码 MD5 哈希值
<ul><li>对于 urls，使用 Base 62 编码 <code class="hljs inline no-lang">[a-zA-Z0-9]</code> 是比较合适的</li> <li>对于每一个原始输入只会有一个 hash 结果，Base 62 是确定的（不涉及随机性）</li> <li>Base 64 是另外一个流行的编码方案，但是对于 urls，会因为额外的 <code class="hljs inline no-lang">+</code> 和 <code class="hljs inline no-lang">-</code> 字符串而产生一些问题</li> <li>以下 <a href="http://stackoverflow.com/questions/742013/how-to-code-a-url-shortener">Base 62 伪代码</a> 执行的时间复杂度是 O(k)，k 是数字的数量 = 7：</li></ul></li></ul> <pre><code class="hljs python"><span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">base_encode</span>(<span class="hljs-params">num, base=<span class="hljs-number">62</span></span>):</span>
</span><span>    digits = []
</span><span>    <span class="hljs-keyword">while</span> num &gt; <span class="hljs-number">0</span>
</span><span>      remainder = modulo(num, base)
</span><span>      digits.push(remainder)
</span><span>      num = divide(num, base)
</span><span>    digits = digits.reverse
</span></code></pre><ul><li>取输出的前 7 个字符，结果会有 62^7 个可能的值，应该足以满足在 3 年内处理 3.6 亿个短链接的约束：</li></ul> <pre><code class="hljs python"><span>url = base_encode(md5(ip_address+timestamp))[:URL_LENGTH]
</span></code></pre><p>我们将会用一个公开的 <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest"><strong>REST 风格接口</strong></a>：</p> <pre><code class="hljs shell"><span><span class="hljs-meta">$</span><span class="bash"> curl -X POST --data <span class="hljs-string">'{&quot;expiration_length_in_minutes&quot;:&quot;60&quot;, \&quot;paste_contents&quot;:&quot;Hello World!&quot;}'</span> https://pastebin.com/api/v1/paste</span>
</span></code></pre><p>Response:</p> <pre><code class="hljs json"><span>{
</span><span>    <span class="hljs-attr">&quot;shortlink&quot;</span>: <span class="hljs-string">&quot;foobar&quot;</span>
</span><span>}
</span></code></pre><p>用于内部通信，我们可以用 <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a>。</p> <h3 id="paste-url"><span id="paste-url" class="anchor"></span>用例：用户输入一个 paste 的 url 后可以看到它存储的内容<a href="#paste-url" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><strong>客户端</strong> 发送一个获取 paste 请求到 <strong>Web Server</strong></li> <li><strong>Web Server</strong> 转发请求给 <strong>读取接口</strong> 服务器</li> <li><strong>读取接口</strong> 服务器执行如下操作：
<ul><li>在 <strong>SQL 数据库</strong> 检查这个生成的 url
<ul><li>如果这个 url 在 <strong>SQL 数据库</strong> 里面，则从 <strong>对象存储</strong> 获取这个 paste 的内容</li> <li>否则，返回一个错误页面给用户</li></ul></li></ul></li></ul> <p>REST API：</p> <pre><code class="hljs shell"><span>curl https://pastebin.com/api/v1/paste?shortlink=foobar
</span></code></pre><p>Response:</p> <pre><code class="hljs json"><span>{
</span><span>    <span class="hljs-attr">&quot;paste_contents&quot;</span>: <span class="hljs-string">&quot;Hello World&quot;</span>,
</span><span>    <span class="hljs-attr">&quot;created_at&quot;</span>: <span class="hljs-string">&quot;YYYY-MM-DD HH:MM:SS&quot;</span>,
</span><span>    <span class="hljs-attr">&quot;expiration_length_in_minutes&quot;</span>: <span class="hljs-string">&quot;60&quot;</span>
</span><span>}
</span></code></pre><h3 id="-11"><span id="-11" class="anchor"></span>用例： 服务跟踪分析页面<a href="#-11" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>因为实时分析不是必须的，所以我们可以简单的 <strong>MapReduce</strong> <strong>Web Server</strong> 的日志，用来生成点击次数。</p> <pre><code class="hljs python"><span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HitCounts</span>(<span class="hljs-params">MRJob</span>):</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_url</span>(<span class="hljs-params">self, line</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;Extract the generated url from the log line.&quot;&quot;&quot;</span>
</span><span>        ...
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_year_month</span>(<span class="hljs-params">self, line</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;Return the year and month portions of the timestamp.&quot;&quot;&quot;</span>
</span><span>        ...
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mapper</span>(<span class="hljs-params">self, _, line</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;Parse each log line, extract and transform relevant lines.</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        Emit key value pairs of the form:</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        (2016-01, url0), 1</span>
</span><span><span class="hljs-string">        (2016-01, url0), 1</span>
</span><span><span class="hljs-string">        (2016-01, url1), 1</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        url = self.extract_url(line)
</span><span>        period = self.extract_year_month(line)
</span><span>        <span class="hljs-keyword">yield</span> (period, url), <span class="hljs-number">1</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reducer</span>(<span class="hljs-params">self, key, values</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;Sum values for each key.</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        (2016-01, url0), 2</span>
</span><span><span class="hljs-string">        (2016-01, url1), 1</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        <span class="hljs-keyword">yield</span> key, <span class="hljs-built_in">sum</span>(values)
</span></code></pre><h3 id="pastes"><span id="pastes" class="anchor"></span>用例： 服务删除过期的 pastes<a href="#pastes" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>为了删除过期的 pastes，我们可以直接搜索 <strong>SQL 数据库</strong> 中所有的过期时间比当前时间更早的记录，
所有过期的记录将从这张表里面删除（或者将其标记为过期）。</p> <h2 id="-12"><span id="-12" class="anchor"></span>第四步：扩展这个设计<a href="#-12" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>给定约束条件，识别和解决瓶颈。</p></blockquote> <p><a href="http://i.imgur.com/4edXG0T.png" target="_self"><img src="http://i.imgur.com/4edXG0T.png" alt="" class="img-fluid"></a></p> <p><strong>重要提示: 不要简单的从最初的设计直接跳到最终的设计</strong></p> <p>说明您将迭代地执行这样的操作：1)<strong>Benchmark/Load 测试</strong>，2)<strong>Profile</strong> 出瓶颈，3)在评估替代方案和权衡时解决瓶颈，4)重复前面，可以参考<a href="/solutions/system_design/scaling_aws/README.html">在 AWS 上设计一个可以支持百万用户的系统</a>这个用来解决如何迭代地扩展初始设计的例子。</p> <p>重要的是讨论在初始设计中可能遇到的瓶颈，以及如何解决每个瓶颈。比如，在多个 <strong>Web 服务器</strong> 上添加 <strong>负载平衡器</strong> 可以解决哪些问题？ <strong>CDN</strong> 解决哪些问题？<strong>Master-Slave Replicas</strong> 解决哪些问题? 替代方案是什么和怎么对每一个替代方案进行权衡比较？</p> <p>我们将介绍一些组件来完成设计，并解决可伸缩性问题。内部的负载平衡器并不能减少杂乱。</p> <p><strong>为了避免重复的讨论</strong>， 参考以下<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题</a>获取主要讨论要点、权衡和替代方案：</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F">DNS</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%E7%BD%91%E7%BB%9Ccdn">CDN</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">负载均衡器</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95">水平扩展</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理（web 服务器）</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E5%B1%82">应用层</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98">缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9Frdbms">关系型数据库管理系统 (RDBMS)</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2">SQL write master-slave failover</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">主从复制</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%BC%8F">一致性模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F">可用性模式</a></li></ul> <p><strong>分析存储数据库</strong> 可以用比如 Amazon Redshift 或者 Google BigQuery 这样的数据仓库解决方案。</p> <p>一个像 Amazon S3 这样的 <strong>对象存储</strong>，可以轻松处理每月 12.7 GB 的新内容约束。</p> <p>要处理 <em>平均</em> 每秒 40 读请求(峰值更高)，其中热点内容的流量应该由 <strong>内存缓存</strong> 处理，而不是数据库。<strong>内存缓存</strong> 对于处理分布不均匀的流量和流量峰值也很有用。只要副本没有陷入复制写的泥潭，<strong>SQL Read Replicas</strong> 应该能够处理缓存丢失。</p> <p>对于单个 <strong>SQL Write Master-Slave</strong>，<em>平均</em> 每秒 4paste 写入 (峰值更高) 应该是可以做到的。否则，我们需要使用额外的 SQL 扩展模式:</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96">非规范化</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#SQL%E8%B0%83%E4%BC%98">SQL 调优</a></li></ul> <p>我们还应该考虑将一些数据移动到 <strong>NoSQL 数据库</strong>。</p> <h2 id="-13"><span id="-13" class="anchor"></span>额外的话题<a href="#-13" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>是否更深入探讨额外主题，取决于问题的范围和面试剩余的时间。</p></blockquote> <h3 id="nosql"><span id="nosql" class="anchor"></span>NoSQL<a href="#nosql" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">键值存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">文档存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8">列型存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93">图数据库</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">sql 还是 nosql</a></li></ul> <h3 id="-14"><span id="-14" class="anchor"></span>缓存<a href="#-14" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>在哪缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98">客户端缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E7%BC%93%E5%AD%98">CDN 缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98">Web 服务器缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98">数据库缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98">应用缓存</a></li></ul></li> <li>缓存什么
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">数据库查询级别的缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">对象级别的缓存</a></li></ul></li> <li>何时更新缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F">直写模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F">回写模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%B7%E6%96%B0">刷新</a></li></ul></li></ul> <h3 id="-15"><span id="-15" class="anchor"></span>异步和微服务<a href="#-15" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97">任务队列</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%83%8C%E5%8E%8B">背压</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a></li></ul> <h3 id="-16"><span id="-16" class="anchor"></span>通信<a href="#-16" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>讨论权衡:
<ul><li>跟客户端之间的外部通信 - <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">HTTP APIs following REST</a></li> <li>内部通信 - <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a></li></ul></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li></ul> <h3 id="-17"><span id="-17" class="anchor"></span>安全<a href="#-17" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>参考<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%89%E5%85%A8">安全</a>。</p> <h3 id="-18"><span id="-18" class="anchor"></span>延迟数字<a href="#-18" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>见<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AF%8F%E4%B8%AA%E7%A8%8B%E5%BA%8F%E5%91%98%E9%83%BD%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%95%B0">每个程序员都应该知道的延迟数</a>。</p> <h3 id="-19"><span id="-19" class="anchor"></span>持续进行<a href="#-19" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>继续对系统进行基准测试和监控，以在瓶颈出现时解决它们</li> <li>扩展是一个迭代的过程</li></ul> <i id="scroll-top-button" onclick="handleScrollTop()" aria-hidden="true" class="fa fa-arrow-circle-up fa-lg d-print-none"></i></div> <nav id="page-nav" class="fixed-header-padding" data-v-e8c82f88><div class="nav-component slim-scroll" data-v-e8c82f88></div> <!----></nav></div> <footer><div class="text-center"><small>[Generated by <a href="https://markbind.org/">MarkBind 3.1.1</a>]</small></div></footer></div>
</body><script src="../../../markbind/js/bootstrap-utility.min.js"></script>
<script>
  MarkBind.setupWithSearch()
</script>
</html>
