<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="generator" content="MarkBind 3.1.1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="../../../markbind/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../markbind/css/bootstrap-vue.min.css">
    <link rel="stylesheet" href="../../../markbind/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../../../markbind/glyphicons/css/bootstrap-glyphicons.min.css">
    <link rel="stylesheet" href="../../../markbind/css/octicons.css">
    <link rel="stylesheet" href="../../../markbind/material-icons/material-icons.css">
    <link rel="stylesheet" href="../../../markbind/css/codeblock-dark.min.css"><link rel="stylesheet" href="../../../markbind/css/markbind.min.css"><script src="../../../markbind/js/polyfill.min.js"></script>
    <script src="../../../markbind/js/vue.min.js"></script>
    <script src="../../../markbind/js/markbind.min.js"></script>
    <script src="README.page-vue-render.js"></script>
    <script src="../../../markbind/js/jquery.min.js"></script><link rel="stylesheet" href="https:/mazx4960.github.io/system-design-primer/plugins/markbind-plugin-anchors/markbind-plugin-anchors.css">
    
  <link rel="stylesheet" href="https://mazx4960.github.io/system-design-primer//stylesheets/main.css">
</head>
<script>
  const baseUrl = 'https://mazx4960.github.io/system-design-primer/'
</script>
<body  data-spy="scroll" data-target="#mb-page-nav" data-offset="100" >
<div id="app" data-server-rendered="true"><header fixed=""><div data-v-15113a2f><nav class="navbar navbar-expand-md navbar-dark bg-dark" data-v-15113a2f><div class="container-fluid" data-v-15113a2f><div class="navbar-left" data-v-15113a2f><a href="https://mazx4960.github.io/system-design-primer//index.html" title="Home" class="navbar-brand" data-v-15113a2f>System Design Primer</a></div> <div class="navbar-default" data-v-15113a2f><ul class="navbar-nav mr-auto mt-2 mt-lg-0" data-v-15113a2f> <li class="nav-link dropdown" data-v-2e98b3f0><a role="button" class="dropdown-toggle" data-v-2e98b3f0>Solutions</a> <ul class="dropdown-menu" data-v-2e98b3f0> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/mint/README.html" class="dropdown-item" data-v-2e98b3f0>mint</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/pastebin/README.html" class="dropdown-item" data-v-2e98b3f0>pastebin</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/query_cache/README.html" class="dropdown-item" data-v-2e98b3f0>query_cache</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/sales_rank/README.html" class="dropdown-item" data-v-2e98b3f0>sales_rank</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/scaling_aws/README.html" class="dropdown-item" data-v-2e98b3f0>scaling_aws</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/social_graph/README.html" class="dropdown-item" data-v-2e98b3f0>social_graph</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/twitter/README.html" class="dropdown-item" data-v-2e98b3f0>twitter</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/web_crawler/README.html" class="dropdown-item" data-v-2e98b3f0>web_crawler</a></li></ul></li></ul></div> <ul class="navbar-nav navbar-right" data-v-15113a2f><li data-v-15113a2f><form class="navbar-form" data-v-15113a2f><div style="position:relative;"><input type="text" placeholder="Search" autocomplete="off" value="" class="form-control"> <ul class="dropdown-menu search-dropdown-menu dropdown-menu-right"></ul></div></form></li></ul></div></nav> <div class="lower-navbar-container" style="display:none;" data-v-15113a2f><!----> <!----></div></div></header> <div id="flex-body"><nav id="site-nav" class="fixed-header-padding" data-v-e8c82f88><div class="site-nav-top" data-v-e8c82f88><div class="font-weight-bold mb-2" style="font-size:1.25rem;" data-v-e8c82f88>Topics</div></div> <div class="nav-component slim-scroll" data-v-e8c82f88><div class="site-nav-root"><ul class="site-nav-list site-nav-list-root" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Preface

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Motivation.html" data-v-e8c82f88>Motivation</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Ankiflashcards.html" data-v-e8c82f88>Anki flashcards</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Indexof-system-design-topics.html" data-v-e8c82f88>Index</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Studyguide.html" data-v-e8c82f88>Study Guide</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Interview Questions

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Howto-approach-a-system-design-interview-question.html" data-v-e8c82f88>How to approach a system design interview question</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Object-orienteddesign-interview-questions-with-solutions.html" data-v-e8c82f88>OOP interview questions</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Systemdesign-interview-questions-with-solutions.html" data-v-e8c82f88>System design interview questions</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Systemdesign-topics-start-here.html" data-v-e8c82f88>System design topics</a> <i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Performancevs-scalability.html" data-v-e8c82f88>Performance vs scalability</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Latencyvs-throughput.html" data-v-e8c82f88>Latency vs throughput</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Availabilityvs-consistency.html" data-v-e8c82f88>Availability vs consistency</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Consistencypatterns.html" data-v-e8c82f88>Consistency patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Availabilitypatterns.html" data-v-e8c82f88>Availability patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Domainname-system.html" data-v-e8c82f88>Domain name system</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contentdelivery-network.html" data-v-e8c82f88>Content delivery network</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Loadbalancer.html" data-v-e8c82f88>Load balancer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Reverseproxy-(web-server).html" data-v-e8c82f88>Reverse proxy (web server)</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Applicationlayer.html" data-v-e8c82f88>Application layer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Database.html" data-v-e8c82f88>Database</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Cache.html" data-v-e8c82f88>Cache</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Asynchronism.html" data-v-e8c82f88>Asynchronism</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Communication.html" data-v-e8c82f88>Communication</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Security.html" data-v-e8c82f88>Security</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Misc

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Appendix.html" data-v-e8c82f88>Appendix</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Underdevelopment.html" data-v-e8c82f88>Under development</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Credits.html" data-v-e8c82f88>Credits</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contactinfo.html" data-v-e8c82f88>Contact info</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contributing.html" data-v-e8c82f88>Contributing</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/License.html" data-v-e8c82f88>License</a></div></li></ul></li> <!----></ul></div></div> <!----></nav> <div id="content-wrapper" class="fixed-header-padding"><br> <h1 id="design-the-twitter-timeline-and-search"><span id="design-the-twitter-timeline-and-search" class="anchor"></span>Design the Twitter timeline and search<a href="#design-the-twitter-timeline-and-search" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h1> <p><em>Note: This document links directly to relevant areas found in the <a href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system design topics</a> to avoid duplication.  Refer to the linked content for general talking points, tradeoffs, and alternatives.</em></p> <p><strong>Design the Facebook feed</strong> and <strong>Design Facebook search</strong> are similar questions.</p> <h2 id="step-1-outline-use-cases-and-constraints"><span id="step-1-outline-use-cases-and-constraints" class="anchor"></span>Step 1: Outline use cases and constraints<a href="#step-1-outline-use-cases-and-constraints" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>Gather requirements and scope the problem.
Ask questions to clarify use cases and constraints.
Discuss assumptions.</p></blockquote> <p>Without an interviewer to address clarifying questions, we'll define some use cases and constraints.</p> <h3 id="use-cases"><span id="use-cases" class="anchor"></span>Use cases<a href="#use-cases" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="we-ll-scope-the-problem-to-handle-only-the-following-use-cases"><span id="we-ll-scope-the-problem-to-handle-only-the-following-use-cases" class="anchor"></span>We'll scope the problem to handle only the following use cases<a href="#we-ll-scope-the-problem-to-handle-only-the-following-use-cases" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><strong>User</strong> posts a tweet
<ul><li><strong>Service</strong> pushes tweets to followers, sending push notifications and emails</li></ul></li> <li><strong>User</strong> views the user timeline (activity from the user)</li> <li><strong>User</strong> views the home timeline (activity from people the user is following)</li> <li><strong>User</strong> searches keywords</li> <li><strong>Service</strong> has high availability</li></ul> <h4 id="out-of-scope"><span id="out-of-scope" class="anchor"></span>Out of scope<a href="#out-of-scope" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><strong>Service</strong> pushes tweets to the Twitter Firehose and other streams</li> <li><strong>Service</strong> strips out tweets based on users' visibility settings
<ul><li>Hide @reply if the user is not also following the person being replied to</li> <li>Respect 'hide retweets' setting</li></ul></li> <li>Analytics</li></ul> <h3 id="constraints-and-assumptions"><span id="constraints-and-assumptions" class="anchor"></span>Constraints and assumptions<a href="#constraints-and-assumptions" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="state-assumptions"><span id="state-assumptions" class="anchor"></span>State assumptions<a href="#state-assumptions" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p>General</p> <ul><li>Traffic is not evenly distributed</li> <li>Posting a tweet should be fast
<ul><li>Fanning out a tweet to all of your followers should be fast, unless you have millions of followers</li></ul></li> <li>100 million active users</li> <li>500 million tweets per day or 15 billion tweets per month
<ul><li>Each tweet averages a fanout of 10 deliveries</li> <li>5 billion total tweets delivered on fanout per day</li> <li>150 billion tweets delivered on fanout per month</li></ul></li> <li>250 billion read requests per month</li> <li>10 billion searches per month</li></ul> <p>Timeline</p> <ul><li>Viewing the timeline should be fast</li> <li>Twitter is more read heavy than write heavy
<ul><li>Optimize for fast reads of tweets</li></ul></li> <li>Ingesting tweets is write heavy</li></ul> <p>Search</p> <ul><li>Searching should be fast</li> <li>Search is read-heavy</li></ul> <h4 id="calculate-usage"><span id="calculate-usage" class="anchor"></span>Calculate usage<a href="#calculate-usage" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p><strong>Clarify with your interviewer if you should run back-of-the-envelope usage calculations.</strong></p> <ul><li>Size per tweet:
<ul><li><code class="hljs inline no-lang">tweet_id</code> - 8 bytes</li> <li><code class="hljs inline no-lang">user_id</code> - 32 bytes</li> <li><code class="hljs inline no-lang">text</code> - 140 bytes</li> <li><code class="hljs inline no-lang">media</code> - 10 KB average</li> <li>Total: ~10 KB</li></ul></li> <li>150 TB of new tweet content per month
<ul><li>10 KB per tweet * 500 million tweets per day * 30 days per month</li> <li>5.4 PB of new tweet content in 3 years</li></ul></li> <li>100 thousand read requests per second
<ul><li>250 billion read requests per month * (400 requests per second / 1 billion requests per month)</li></ul></li> <li>6,000 tweets per second
<ul><li>15 billion tweets per month * (400 requests per second / 1 billion requests per month)</li></ul></li> <li>60 thousand tweets delivered on fanout per second
<ul><li>150 billion tweets delivered on fanout per month * (400 requests per second / 1 billion requests per month)</li></ul></li> <li>4,000 search requests per second
<ul><li>10 billion searches per month * (400 requests per second / 1 billion requests per month)</li></ul></li></ul> <p>Handy conversion guide:</p> <ul><li>2.5 million seconds per month</li> <li>1 request per second = 2.5 million requests per month</li> <li>40 requests per second = 100 million requests per month</li> <li>400 requests per second = 1 billion requests per month</li></ul> <h2 id="step-2-create-a-high-level-design"><span id="step-2-create-a-high-level-design" class="anchor"></span>Step 2: Create a high level design<a href="#step-2-create-a-high-level-design" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>Outline a high level design with all important components.</p></blockquote> <p><a href="http://i.imgur.com/48tEA2j.png" target="_self"><img src="http://i.imgur.com/48tEA2j.png" alt="" class="img-fluid"></a></p> <h2 id="step-3-design-core-components"><span id="step-3-design-core-components" class="anchor"></span>Step 3: Design core components<a href="#step-3-design-core-components" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>Dive into details for each core component.</p></blockquote> <h3 id="use-case-user-posts-a-tweet"><span id="use-case-user-posts-a-tweet" class="anchor"></span>Use case: User posts a tweet<a href="#use-case-user-posts-a-tweet" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>We could store the user's own tweets to populate the user timeline (activity from the user) in a <a href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">relational database</a>.  We should discuss the <a href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">use cases and tradeoffs between choosing SQL or NoSQL</a>.</p> <p>Delivering tweets and building the home timeline (activity from people the user is following) is trickier.  Fanning out tweets to all followers (60 thousand tweets delivered on fanout per second) will overload a traditional <a href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">relational database</a>.  We'll probably want to choose a data store with fast writes such as a <strong>NoSQL database</strong> or <strong>Memory Cache</strong>.  Reading 1 MB sequentially from memory takes about 250 microseconds, while reading from SSD takes 4x and from disk takes 80x longer.<sup><a href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">1</a></sup></p> <p>We could store media such as photos or videos on an <strong>Object Store</strong>.</p> <ul><li>The <strong>Client</strong> posts a tweet to the <strong>Web Server</strong>, running as a <a href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse proxy</a></li> <li>The <strong>Web Server</strong> forwards the request to the <strong>Write API</strong> server</li> <li>The <strong>Write API</strong> stores the tweet in the user's timeline on a <strong>SQL database</strong></li> <li>The <strong>Write API</strong> contacts the <strong>Fan Out Service</strong>, which does the following:
<ul><li>Queries the <strong>User Graph Service</strong> to find the user's followers stored in the <strong>Memory Cache</strong></li> <li>Stores the tweet in the <em>home timeline of the user's followers</em> in a <strong>Memory Cache</strong> <ul><li>O(n) operation:  1,000 followers = 1,000 lookups and inserts</li></ul></li> <li>Stores the tweet in the <strong>Search Index Service</strong> to enable fast searching</li> <li>Stores media in the <strong>Object Store</strong></li> <li>Uses the <strong>Notification Service</strong> to send out push notifications to followers:
<ul><li>Uses a <strong>Queue</strong> (not pictured) to asynchronously send out notifications</li></ul></li></ul></li></ul> <p><strong>Clarify with your interviewer how much code you are expected to write</strong>.</p> <p>If our <strong>Memory Cache</strong> is Redis, we could use a native Redis list with the following structure:</p> <pre><code class="hljs"><span>           tweet n+2                   tweet n+1                   tweet n
</span><span>| 8 bytes   8 bytes  1 byte | 8 bytes   8 bytes  1 byte | 8 bytes   8 bytes  1 byte |
</span><span>| tweet_id  user_id  meta   | tweet_id  user_id  meta   | tweet_id  user_id  meta   |
</span></code></pre><p>The new tweet would be placed in the <strong>Memory Cache</strong>, which populates the user's home timeline (activity from people the user is following).</p> <p>We'll use a public <a href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST API</strong></a>:</p> <pre><code class="hljs"><span>$ curl -X POST --data '{ &quot;user_id&quot;: &quot;123&quot;, &quot;auth_token&quot;: &quot;ABC123&quot;, \
</span><span>    &quot;status&quot;: &quot;hello world!&quot;, &quot;media_ids&quot;: &quot;ABC987&quot; }' \
</span><span>    https://twitter.com/api/v1/tweet
</span></code></pre><p>Response:</p> <pre><code class="hljs"><span>{
</span><span>    &quot;created_at&quot;: &quot;Wed Sep 05 00:37:15 +0000 2012&quot;,
</span><span>    &quot;status&quot;: &quot;hello world!&quot;,
</span><span>    &quot;tweet_id&quot;: &quot;987&quot;,
</span><span>    &quot;user_id&quot;: &quot;123&quot;,
</span><span>    ...
</span><span>}
</span></code></pre><p>For internal communications, we could use <a href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote Procedure Calls</a>.</p> <h3 id="use-case-user-views-the-home-timeline"><span id="use-case-user-views-the-home-timeline" class="anchor"></span>Use case: User views the home timeline<a href="#use-case-user-views-the-home-timeline" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>The <strong>Client</strong> posts a home timeline request to the <strong>Web Server</strong></li> <li>The <strong>Web Server</strong> forwards the request to the <strong>Read API</strong> server</li> <li>The <strong>Read API</strong> server contacts the <strong>Timeline Service</strong>, which does the following:
<ul><li>Gets the timeline data stored in the <strong>Memory Cache</strong>, containing tweet ids and user ids - O(1)</li> <li>Queries the <strong>Tweet Info Service</strong> with a <a href="http://redis.io/commands/mget">multiget</a> to obtain additional info about the tweet ids - O(n)</li> <li>Queries the <strong>User Info Service</strong> with a multiget to obtain additional info about the user ids - O(n)</li></ul></li></ul> <p>REST API:</p> <pre><code class="hljs"><span>$ curl https://twitter.com/api/v1/home_timeline?user_id=123
</span></code></pre><p>Response:</p> <pre><code class="hljs"><span>{
</span><span>    &quot;user_id&quot;: &quot;456&quot;,
</span><span>    &quot;tweet_id&quot;: &quot;123&quot;,
</span><span>    &quot;status&quot;: &quot;foo&quot;
</span><span>},
</span><span>{
</span><span>    &quot;user_id&quot;: &quot;789&quot;,
</span><span>    &quot;tweet_id&quot;: &quot;456&quot;,
</span><span>    &quot;status&quot;: &quot;bar&quot;
</span><span>},
</span><span>{
</span><span>    &quot;user_id&quot;: &quot;789&quot;,
</span><span>    &quot;tweet_id&quot;: &quot;579&quot;,
</span><span>    &quot;status&quot;: &quot;baz&quot;
</span><span>},
</span></code></pre><h3 id="use-case-user-views-the-user-timeline"><span id="use-case-user-views-the-user-timeline" class="anchor"></span>Use case: User views the user timeline<a href="#use-case-user-views-the-user-timeline" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>The <strong>Client</strong> posts a user timeline request to the <strong>Web Server</strong></li> <li>The <strong>Web Server</strong> forwards the request to the <strong>Read API</strong> server</li> <li>The <strong>Read API</strong> retrieves the user timeline from the <strong>SQL Database</strong></li></ul> <p>The REST API would be similar to the home timeline, except all tweets would come from the user as opposed to the people the user is following.</p> <h3 id="use-case-user-searches-keywords"><span id="use-case-user-searches-keywords" class="anchor"></span>Use case: User searches keywords<a href="#use-case-user-searches-keywords" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>The <strong>Client</strong> sends a search request to the <strong>Web Server</strong></li> <li>The <strong>Web Server</strong> forwards the request to the <strong>Search API</strong> server</li> <li>The <strong>Search API</strong> contacts the <strong>Search Service</strong>, which does the following:
<ul><li>Parses/tokenizes the input query, determining what needs to be searched
<ul><li>Removes markup</li> <li>Breaks up the text into terms</li> <li>Fixes typos</li> <li>Normalizes capitalization</li> <li>Converts the query to use boolean operations</li></ul></li> <li>Queries the <strong>Search Cluster</strong> (ie <a href="https://lucene.apache.org/">Lucene</a>) for the results:
<ul><li><a href="https://github.com/donnemartin/system-design-primer#under-development">Scatter gathers</a> each server in the cluster to determine if there are any results for the query</li> <li>Merges, ranks, sorts, and returns the results</li></ul></li></ul></li></ul> <p>REST API:</p> <pre><code class="hljs"><span>$ curl https://twitter.com/api/v1/search?query=hello+world
</span></code></pre><p>The response would be similar to that of the home timeline, except for tweets matching the given query.</p> <h2 id="step-4-scale-the-design"><span id="step-4-scale-the-design" class="anchor"></span>Step 4: Scale the design<a href="#step-4-scale-the-design" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>Identify and address bottlenecks, given the constraints.</p></blockquote> <p><a href="http://i.imgur.com/jrUBAF7.png" target="_self"><img src="http://i.imgur.com/jrUBAF7.png" alt="" class="img-fluid"></a></p> <p><strong>Important: Do not simply jump right into the final design from the initial design!</strong></p> <p>State you would 1) <strong>Benchmark/Load Test</strong>, 2) <strong>Profile</strong> for bottlenecks 3) address bottlenecks while evaluating alternatives and trade-offs, and 4) repeat.  See <a href="/mazx4960.github.io/system-design-primer/solutions/system_design/scaling_aws/README.html">Design a system that scales to millions of users on AWS</a> as a sample on how to iteratively scale the initial design.</p> <p>It's important to discuss what bottlenecks you might encounter with the initial design and how you might address each of them.  For example, what issues are addressed by adding a <strong>Load Balancer</strong> with multiple <strong>Web Servers</strong>?  <strong>CDN</strong>?  <strong>Master-Slave Replicas</strong>?  What are the alternatives and <strong>Trade-Offs</strong> for each?</p> <p>We'll introduce some components to complete the design and to address scalability issues.  Internal load balancers are not shown to reduce clutter.</p> <p><em>To avoid repeating discussions</em>, refer to the following <a href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system design topics</a> for main talking points, tradeoffs, and alternatives:</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#content-delivery-network">CDN</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#load-balancer">Load balancer</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal scaling</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web server (reverse proxy)</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#application-layer">API server (application layer)</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational database management system (RDBMS)</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#fail-over">SQL write master-slave failover</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Master-slave replication</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency patterns</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability patterns</a></li></ul> <p>The <strong>Fanout Service</strong> is a potential bottleneck.  Twitter users with millions of followers could take several minutes to have their tweets go through the fanout process.  This could lead to race conditions with @replies to the tweet, which we could mitigate by re-ordering the tweets at serve time.</p> <p>We could also avoid fanning out tweets from highly-followed users.  Instead, we could search to find tweets for highly-followed users, merge the search results with the user's home timeline results, then re-order the tweets at serve time.</p> <p>Additional optimizations include:</p> <ul><li>Keep only several hundred tweets for each home timeline in the <strong>Memory Cache</strong></li> <li>Keep only active users' home timeline info in the <strong>Memory Cache</strong> <ul><li>If a user was not previously active in the past 30 days, we could rebuild the timeline from the <strong>SQL Database</strong> <ul><li>Query the <strong>User Graph Service</strong> to determine who the user is following</li> <li>Get the tweets from the <strong>SQL Database</strong> and add them to the <strong>Memory Cache</strong></li></ul></li></ul></li> <li>Store only a month of tweets in the <strong>Tweet Info Service</strong></li> <li>Store only active users in the <strong>User Info Service</strong></li> <li>The <strong>Search Cluster</strong> would likely need to keep the tweets in memory to keep latency low</li></ul> <p>We'll also want to address the bottleneck with the <strong>SQL Database</strong>.</p> <p>Although the <strong>Memory Cache</strong> should reduce the load on the database, it is unlikely the <strong>SQL Read Replicas</strong> alone would be enough to handle the cache misses.  We'll probably need to employ additional SQL scaling patterns.</p> <p>The high volume of writes would overwhelm a single <strong>SQL Write Master-Slave</strong>, also pointing to a need for additional scaling techniques.</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL Tuning</a></li></ul> <p>We should also consider moving some data to a <strong>NoSQL Database</strong>.</p> <h2 id="additional-talking-points"><span id="additional-talking-points" class="anchor"></span>Additional talking points<a href="#additional-talking-points" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>Additional topics to dive into, depending on the problem scope and time remaining.</p></blockquote> <h4 id="nosql"><span id="nosql" class="anchor"></span>NoSQL<a href="#nosql" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><a href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value store</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#document-store">Document store</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide column store</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#graph-database">Graph database</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL vs NoSQL</a></li></ul> <h3 id="caching"><span id="caching" class="anchor"></span>Caching<a href="#caching" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>Where to cache
<ul><li><a href="https://github.com/donnemartin/system-design-primer#client-caching">Client caching</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN caching</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web server caching</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#database-caching">Database caching</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#application-caching">Application caching</a></li></ul></li> <li>What to cache
<ul><li><a href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching at the database query level</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching at the object level</a></li></ul></li> <li>When to update the cache
<ul><li><a href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind (write-back)</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh ahead</a></li></ul></li></ul> <h3 id="asynchronism-and-microservices"><span id="asynchronism-and-microservices" class="anchor"></span>Asynchronism and microservices<a href="#asynchronism-and-microservices" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><a href="https://github.com/donnemartin/system-design-primer#message-queues">Message queues</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#task-queues">Task queues</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#back-pressure">Back pressure</a></li> <li><a href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li></ul> <h3 id="communications"><span id="communications" class="anchor"></span>Communications<a href="#communications" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>Discuss tradeoffs:
<ul><li>External communication with clients - <a href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP APIs following REST</a></li> <li>Internal communications - <a href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li></ul></li> <li><a href="https://github.com/donnemartin/system-design-primer#service-discovery">Service discovery</a></li></ul> <h3 id="security"><span id="security" class="anchor"></span>Security<a href="#security" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>Refer to the <a href="https://github.com/donnemartin/system-design-primer#security">security section</a>.</p> <h3 id="latency-numbers"><span id="latency-numbers" class="anchor"></span>Latency numbers<a href="#latency-numbers" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>See <a href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency numbers every programmer should know</a>.</p> <h3 id="ongoing"><span id="ongoing" class="anchor"></span>Ongoing<a href="#ongoing" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>Continue benchmarking and monitoring your system to address bottlenecks as they come up</li> <li>Scaling is an iterative process</li></ul> <i id="scroll-top-button" onclick="handleScrollTop()" aria-hidden="true" class="fa fa-arrow-circle-up fa-lg d-print-none"></i></div> <nav id="page-nav" class="fixed-header-padding" data-v-e8c82f88><div class="nav-component slim-scroll" data-v-e8c82f88><a class="navbar-brand page-nav-title" href="#" data-v-e8c82f88>Chapters of This Page</a> <nav id="mb-page-nav" class="nav nav-pills flex-column my-0 small no-flex-wrap" data-v-e8c82f88><a class="nav-link py-1" href="#design-the-twitter-timeline-and-search" data-v-e8c82f88>Design the Twitter timeline and search‎</a> <nav class="nav nav-pills flex-column my-0 nested no-flex-wrap" data-v-e8c82f88><a class="nav-link py-1" href="#step-1-outline-use-cases-and-constraints" data-v-e8c82f88>Step 1: Outline use cases and constraints‎</a> <nav class="nav nav-pills flex-column my-0 nested no-flex-wrap" data-v-e8c82f88><a class="nav-link py-1" href="#use-cases" data-v-e8c82f88>Use cases‎</a> <a class="nav-link py-1" href="#constraints-and-assumptions" data-v-e8c82f88>Constraints and assumptions‎</a></nav> <a class="nav-link py-1" href="#step-2-create-a-high-level-design" data-v-e8c82f88>Step 2: Create a high level design‎</a> <a class="nav-link py-1" href="#step-3-design-core-components" data-v-e8c82f88>Step 3: Design core components‎</a> <nav class="nav nav-pills flex-column my-0 nested no-flex-wrap" data-v-e8c82f88><a class="nav-link py-1" href="#use-case-user-posts-a-tweet" data-v-e8c82f88>Use case: User posts a tweet‎</a> <a class="nav-link py-1" href="#use-case-user-views-the-home-timeline" data-v-e8c82f88>Use case: User views the home timeline‎</a> <a class="nav-link py-1" href="#use-case-user-views-the-user-timeline" data-v-e8c82f88>Use case: User views the user timeline‎</a> <a class="nav-link py-1" href="#use-case-user-searches-keywords" data-v-e8c82f88>Use case: User searches keywords‎</a></nav> <a class="nav-link py-1" href="#step-4-scale-the-design" data-v-e8c82f88>Step 4: Scale the design‎</a> <a class="nav-link py-1" href="#additional-talking-points" data-v-e8c82f88>Additional talking points‎</a> <nav class="nav nav-pills flex-column my-0 nested no-flex-wrap" data-v-e8c82f88><a class="nav-link py-1" href="#caching" data-v-e8c82f88>Caching‎</a> <a class="nav-link py-1" href="#asynchronism-and-microservices" data-v-e8c82f88>Asynchronism and microservices‎</a> <a class="nav-link py-1" href="#communications" data-v-e8c82f88>Communications‎</a> <a class="nav-link py-1" href="#security" data-v-e8c82f88>Security‎</a> <a class="nav-link py-1" href="#latency-numbers" data-v-e8c82f88>Latency numbers‎</a> <a class="nav-link py-1" href="#ongoing" data-v-e8c82f88>Ongoing‎</a></nav></nav> <!----></nav></div> <!----></nav></div> <footer><div class="text-center"><small>[Generated by <a href="https://markbind.org/">MarkBind 3.1.1</a>]</small></div></footer></div>
</body><script src="../../../markbind/js/bootstrap-utility.min.js"></script>
<script>
  MarkBind.setupWithSearch()
</script>
</html>
