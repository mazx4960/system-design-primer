<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="generator" content="MarkBind 3.1.1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="../../../markbind/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../markbind/css/bootstrap-vue.min.css">
    <link rel="stylesheet" href="../../../markbind/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="../../../markbind/glyphicons/css/bootstrap-glyphicons.min.css">
    <link rel="stylesheet" href="../../../markbind/css/octicons.css">
    <link rel="stylesheet" href="../../../markbind/material-icons/material-icons.css">
    <link rel="stylesheet" href="../../../markbind/css/codeblock-dark.min.css"><link rel="stylesheet" href="../../../markbind/css/markbind.min.css"><script src="../../../markbind/js/polyfill.min.js"></script>
    <script src="../../../markbind/js/vue.min.js"></script>
    <script src="../../../markbind/js/markbind.min.js"></script>
    <script src="README-zh-Hans.page-vue-render.js"></script>
    <script src="../../../markbind/js/jquery.min.js"></script><link rel="stylesheet" href="https:/mazx4960.github.io/system-design-primer/plugins/markbind-plugin-anchors/markbind-plugin-anchors.css">
    
  <link rel="stylesheet" href="https://mazx4960.github.io/system-design-primer//stylesheets/main.css">
</head>
<script>
  const baseUrl = 'https://mazx4960.github.io/system-design-primer/'
</script>
<body >
<div id="app" data-server-rendered="true"><header fixed=""><div data-v-15113a2f><nav class="navbar navbar-expand-md navbar-dark bg-dark" data-v-15113a2f><div class="container-fluid" data-v-15113a2f><div class="navbar-left" data-v-15113a2f><a href="https://mazx4960.github.io/system-design-primer//index.html" title="Home" class="navbar-brand" data-v-15113a2f>System Design Primer</a></div> <div class="navbar-default" data-v-15113a2f><ul class="navbar-nav mr-auto mt-2 mt-lg-0" data-v-15113a2f> <li class="nav-link dropdown" data-v-2e98b3f0><a role="button" class="dropdown-toggle" data-v-2e98b3f0>Solutions</a> <ul class="dropdown-menu" data-v-2e98b3f0> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/mint/README.html" class="dropdown-item" data-v-2e98b3f0>mint</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/pastebin/README.html" class="dropdown-item" data-v-2e98b3f0>pastebin</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/query_cache/README.html" class="dropdown-item" data-v-2e98b3f0>query_cache</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/sales_rank/README.html" class="dropdown-item" data-v-2e98b3f0>sales_rank</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/scaling_aws/README.html" class="dropdown-item" data-v-2e98b3f0>scaling_aws</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/social_graph/README.html" class="dropdown-item" data-v-2e98b3f0>social_graph</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/twitter/README.html" class="dropdown-item" data-v-2e98b3f0>twitter</a></li> <li data-v-2e98b3f0><a href="https://mazx4960.github.io/system-design-primer//solutions/system_design/web_crawler/README.html" class="dropdown-item" data-v-2e98b3f0>web_crawler</a></li></ul></li></ul></div> <ul class="navbar-nav navbar-right" data-v-15113a2f><li data-v-15113a2f><form class="navbar-form" data-v-15113a2f><div style="position:relative;"><input type="text" placeholder="Search" autocomplete="off" value="" class="form-control"> <ul class="dropdown-menu search-dropdown-menu dropdown-menu-right"></ul></div></form></li></ul></div></nav> <div class="lower-navbar-container" style="display:none;" data-v-15113a2f><!----> <!----></div></div></header> <div id="flex-body"><nav id="site-nav" class="fixed-header-padding" data-v-e8c82f88><div class="site-nav-top" data-v-e8c82f88><div class="font-weight-bold mb-2" style="font-size:1.25rem;" data-v-e8c82f88>Topics</div></div> <div class="nav-component slim-scroll" data-v-e8c82f88><div class="site-nav-root"><ul class="site-nav-list site-nav-list-root" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Preface

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Motivation.html" data-v-e8c82f88>Motivation</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Ankiflashcards.html" data-v-e8c82f88>Anki flashcards</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Indexof-system-design-topics.html" data-v-e8c82f88>Index</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Studyguide.html" data-v-e8c82f88>Study Guide</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Interview Questions

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Howto-approach-a-system-design-interview-question.html" data-v-e8c82f88>How to approach a system design interview question</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Object-orienteddesign-interview-questions-with-solutions.html" data-v-e8c82f88>OOP interview questions</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Systemdesign-interview-questions-with-solutions.html" data-v-e8c82f88>System design interview questions</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Systemdesign-topics-start-here.html" data-v-e8c82f88>System design topics</a> <i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Performancevs-scalability.html" data-v-e8c82f88>Performance vs scalability</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Latencyvs-throughput.html" data-v-e8c82f88>Latency vs throughput</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Availabilityvs-consistency.html" data-v-e8c82f88>Availability vs consistency</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Consistencypatterns.html" data-v-e8c82f88>Consistency patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Availabilitypatterns.html" data-v-e8c82f88>Availability patterns</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Domainname-system.html" data-v-e8c82f88>Domain name system</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contentdelivery-network.html" data-v-e8c82f88>Content delivery network</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Loadbalancer.html" data-v-e8c82f88>Load balancer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Reverseproxy-(web-server).html" data-v-e8c82f88>Reverse proxy (web server)</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Applicationlayer.html" data-v-e8c82f88>Application layer</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Database.html" data-v-e8c82f88>Database</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Cache.html" data-v-e8c82f88>Cache</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Asynchronism.html" data-v-e8c82f88>Asynchronism</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Communication.html" data-v-e8c82f88>Communication</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Security.html" data-v-e8c82f88>Security</a></div></li></ul></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-0" data-v-e8c82f88>Misc

<i onclick="handleSiteNavClick(this.parentNode, false); event.stopPropagation();" class="site-nav-dropdown-btn-icon" data-v-e8c82f88><span aria-hidden="true" class="glyphicon glyphicon-menu-down" data-v-e8c82f88></span></i></div><ul class="site-nav-dropdown-container site-nav-list" data-v-e8c82f88><li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Appendix.html" data-v-e8c82f88>Appendix</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Underdevelopment.html" data-v-e8c82f88>Under development</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Credits.html" data-v-e8c82f88>Credits</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contactinfo.html" data-v-e8c82f88>Contact info</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/Contributing.html" data-v-e8c82f88>Contributing</a></div></li> <li data-v-e8c82f88><div onclick="handleSiteNavClick(this)" class="site-nav-default-list-item site-nav-list-item-1" data-v-e8c82f88><a href="https://mazx4960.github.io/system-design-primer//contents/License.html" data-v-e8c82f88>License</a></div></li></ul></li> <!----></ul></div></div> <!----></nav> <div id="content-wrapper" class="fixed-header-padding"><h1 id="web"><span id="web" class="anchor"></span>设计一个键-值缓存来存储最近 web 服务查询的结果<a href="#web" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h1> <p><strong>注意：这个文档中的链接会直接指向<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题索引</a>中的有关部分，以避免重复的内容。你可以参考链接的相关内容，来了解其总的要点、方案的权衡取舍以及可选的替代方案。</strong></p> <h2 id="">第一步：简述用例与约束条件</h2> <blockquote><p>搜集需求与问题的范围。
提出问题来明确用例与约束条件。
讨论假设。</p></blockquote> <p>我们将在没有面试官明确说明问题的情况下，自己定义一些用例以及限制条件。</p> <h3 id="-2"><span id="-2" class="anchor"></span>用例<a href="#-2" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="-3"><span id="-3" class="anchor"></span>我们将把问题限定在仅处理以下用例的范围中<a href="#-3" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><strong>用户</strong>发送一个搜索请求，命中缓存</li> <li><strong>用户</strong>发送一个搜索请求，未命中缓存</li> <li><strong>服务</strong>有着高可用性</li></ul> <h3 id="-4"><span id="-4" class="anchor"></span>限制条件与假设<a href="#-4" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <h4 id="-5"><span id="-5" class="anchor"></span>提出假设<a href="#-5" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li>网络流量不是均匀分布的
<ul><li>经常被查询的内容应该一直存于缓存中</li> <li>需要确定如何规定缓存过期、缓存刷新规则</li></ul></li> <li>缓存提供的服务查询速度要快</li> <li>机器间延迟较低</li> <li>缓存有内存限制
<ul><li>需要决定缓存什么、移除什么</li> <li>需要缓存百万级的查询</li></ul></li> <li>1000 万用户</li> <li>每个月 100 亿次查询</li></ul> <h4 id="-6"><span id="-6" class="anchor"></span>计算用量<a href="#-6" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p><strong>如果你需要进行粗略的用量计算，请向你的面试官说明。</strong></p> <ul><li>缓存存储的是键值对有序表，键为 <code class="hljs inline no-lang">query</code>（查询），值为 <code class="hljs inline no-lang">results</code>（结果）。
<ul><li><code class="hljs inline no-lang">query</code> - 50 字节</li> <li><code class="hljs inline no-lang">title</code> - 20 字节</li> <li><code class="hljs inline no-lang">snippet</code> - 200 字节</li> <li>总计：270 字节</li></ul></li> <li>假如 100 亿次查询都是不同的，且全部需要存储，那么每个月需要 2.7 TB 的缓存空间
<ul><li>单次查询 270 字节 * 每月查询 100 亿次</li> <li>假设内存大小有限制，需要决定如何制定缓存过期规则</li></ul></li> <li>每秒 4,000 次请求</li></ul> <p>便利换算指南：</p> <ul><li>每个月有 250 万秒</li> <li>每秒一个请求 = 每个月 250 万次请求</li> <li>每秒 40 个请求 = 每个月 1 亿次请求</li> <li>每秒 400 个请求 = 每个月 10 亿次请求</li></ul> <h2 id="-7"><span id="-7" class="anchor"></span>第二步：概要设计<a href="#-7" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>列出所有重要组件以规划概要设计。</p></blockquote> <p><a href="http://i.imgur.com/KqZ3dSx.png" target="_self"><img src="http://i.imgur.com/KqZ3dSx.png" alt="" class="img-fluid"></a></p> <h2 id="-8"><span id="-8" class="anchor"></span>第三步：设计核心组件<a href="#-8" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>深入每个核心组件的细节。</p></blockquote> <h3 id="-9"><span id="-9" class="anchor"></span>用例：用户发送了一次请求，命中了缓存<a href="#-9" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>常用的查询可以由例如 Redis 或者 Memcached 之类的<strong>内存缓存</strong>提供支持，以减少数据读取延迟，并且避免<strong>反向索引服务</strong>以及<strong>文档服务</strong>的过载。从内存读取 1 MB 连续数据大约要花 250 微秒，而从 SSD 读取同样大小的数据要花费 4 倍的时间，从机械硬盘读取需要花费 80 倍以上的时间。<sup><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#每个程序员都应该知道的延迟数">1</a></sup></p> <p>由于缓存容量有限，我们将使用 LRU（近期最少使用算法）来控制缓存的过期。</p> <ul><li><strong>客户端</strong>向运行<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理</a>的 <strong>Web 服务器</strong>发送一个请求</li> <li>这个 <strong>Web 服务器</strong>将请求转发给<strong>查询 API</strong> 服务</li> <li><strong>查询 API</strong> 服务将会做这些事情：
<ul><li>分析查询
<ul><li>移除多余的内容</li> <li>将文本分割成词组</li> <li>修正拼写错误</li> <li>规范化字母的大小写</li> <li>将查询转换为布尔运算</li></ul></li> <li>检测<strong>内存缓存</strong>是否有匹配查询的内容
<ul><li>如果命中<strong>内存缓存</strong>，<strong>内存缓存</strong>将会做以下事情：
<ul><li>将缓存入口的位置指向 LRU 链表的头部</li> <li>返回缓存内容</li></ul></li> <li>否则，<strong>查询 API</strong> 将会做以下事情：
<ul><li>使用<strong>反向索引服务</strong>来查找匹配查询的文档
<ul><li><strong>反向索引服务</strong>对匹配到的结果进行排名，然后返回最符合的结果</li></ul></li> <li>使用<strong>文档服务</strong>返回文章标题与片段</li> <li>更新<strong>内存缓存</strong>，存入内容，将<strong>内存缓存</strong>入口位置指向 LRU 链表的头部</li></ul></li></ul></li></ul></li></ul> <h4 id="-10"><span id="-10" class="anchor"></span>缓存的实现<a href="#-10" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p>缓存可以使用双向链表实现：新元素将会在头结点加入，过期的元素将会在尾节点被删除。我们使用哈希表以便能够快速查找每个链表节点。</p> <p><strong>向你的面试官告知你准备写多少代码</strong>。</p> <p>实现<strong>查询 API 服务</strong>：</p> <pre><code class="hljs python"><span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueryApi</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, memory_cache, reverse_index_service</span>):</span>
</span><span>        self.memory_cache = memory_cache
</span><span>        self.reverse_index_service = reverse_index_service
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_query</span>(<span class="hljs-params">self, query</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;移除多余内容，将文本分割成词组，修复拼写错误，</span>
</span><span><span class="hljs-string">        规范化字母大小写，转换布尔运算。</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        ...
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_query</span>(<span class="hljs-params">self, query</span>):</span>
</span><span>        query = self.parse_query(query)
</span><span>        results = self.memory_cache.get(query)
</span><span>        <span class="hljs-keyword">if</span> results <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
</span><span>            results = self.reverse_index_service.process_search(query)
</span><span>            self.memory_cache.<span class="hljs-built_in">set</span>(query, results)
</span><span>        <span class="hljs-keyword">return</span> results
</span></code></pre><p>实现<strong>节点</strong>：</p> <pre><code class="hljs python"><span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query, results</span>):</span>
</span><span>        self.query = query
</span><span>        self.results = results
</span></code></pre><p>实现<strong>链表</strong>：</p> <pre><code class="hljs python"><span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinkedList</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span>
</span><span>        self.head = <span class="hljs-literal">None</span>
</span><span>        self.tail = <span class="hljs-literal">None</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">move_to_front</span>(<span class="hljs-params">self, node</span>):</span>
</span><span>        ...
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_to_front</span>(<span class="hljs-params">self, node</span>):</span>
</span><span>        ...
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">remove_from_tail</span>(<span class="hljs-params">self</span>):</span>
</span><span>        ...
</span></code></pre><p>实现<strong>缓存</strong>：</p> <pre><code class="hljs python"><span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, MAX_SIZE</span>):</span>
</span><span>        self.MAX_SIZE = MAX_SIZE
</span><span>        self.size = <span class="hljs-number">0</span>
</span><span>        self.lookup = {}  <span class="hljs-comment"># key: query, value: node</span>
</span><span>        self.linked_list = LinkedList()
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, query</span>)</span>
</span><span><span class="hljs-function">        &quot;&quot;&quot;从缓存取得存储的内容</span>
</span><span><span class="hljs-function"></span>
</span><span><span class="hljs-function">        将入口节点位置更新为 <span class="hljs-title">LRU</span> 链表的头部。</span>
</span><span><span class="hljs-function">        &quot;&quot;&quot;</span>
</span><span><span class="hljs-function">        <span class="hljs-title">node</span> = <span class="hljs-title">self</span>.<span class="hljs-title">lookup</span>[<span class="hljs-title">query</span>]</span>
</span><span><span class="hljs-function">        <span class="hljs-title">if</span> <span class="hljs-title">node</span> <span class="hljs-title">is</span> <span class="hljs-title">None</span>:</span>
</span><span>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</span><span>        self.linked_list.move_to_front(node)
</span><span>        <span class="hljs-keyword">return</span> node.results
</span><span>
</span><span>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set</span>(<span class="hljs-params">self, results, query</span>):</span>
</span><span>        <span class="hljs-string">&quot;&quot;&quot;将所给查询键的结果存在缓存中。</span>
</span><span><span class="hljs-string"></span>
</span><span><span class="hljs-string">        当更新缓存记录的时候，将它的位置指向 LRU 链表的头部。</span>
</span><span><span class="hljs-string">        如果这个记录是新的记录，并且缓存空间已满，应该在加入新记录前</span>
</span><span><span class="hljs-string">        删除最老的记录。</span>
</span><span><span class="hljs-string">        &quot;&quot;&quot;</span>
</span><span>        node = self.lookup[query]
</span><span>        <span class="hljs-keyword">if</span> node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
</span><span>            <span class="hljs-comment"># 键存在于缓存中，更新它对应的值</span>
</span><span>            node.results = results
</span><span>            self.linked_list.move_to_front(node)
</span><span>        <span class="hljs-keyword">else</span>:
</span><span>            <span class="hljs-comment"># 键不存在于缓存中</span>
</span><span>            <span class="hljs-keyword">if</span> self.size == self.MAX_SIZE:
</span><span>                <span class="hljs-comment"># 在链表中查找并删除最老的记录</span>
</span><span>                self.lookup.pop(self.linked_list.tail.query, <span class="hljs-literal">None</span>)
</span><span>                self.linked_list.remove_from_tail()
</span><span>            <span class="hljs-keyword">else</span>:
</span><span>                self.size += <span class="hljs-number">1</span>
</span><span>            <span class="hljs-comment"># 添加新的键值对</span>
</span><span>            new_node = Node(query, results)
</span><span>            self.linked_list.append_to_front(new_node)
</span><span>            self.lookup[query] = new_node
</span></code></pre><h4 id="-11"><span id="-11" class="anchor"></span>何时更新缓存<a href="#-11" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <p>缓存将会在以下几种情况更新：</p> <ul><li>页面内容发生变化</li> <li>页面被移除或者加入了新页面</li> <li>页面的权值发生变动</li></ul> <p>解决这些问题的最直接的方法，就是为缓存记录设置一个它在被更新前能留在缓存中的最长时间，这个时间简称为存活时间（TTL）。</p> <p>参考 <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BD%95%E6%97%B6%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">「何时更新缓存」</a>来了解其权衡取舍及替代方案。以上方法在<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a>一章中详细地进行了描述。</p> <h2 id="-12"><span id="-12" class="anchor"></span>第四步：架构扩展<a href="#-12" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>根据限制条件，找到并解决瓶颈。</p></blockquote> <p><a href="http://i.imgur.com/4j99mhe.png" target="_self"><img src="http://i.imgur.com/4j99mhe.png" alt="" class="img-fluid"></a></p> <p><strong>重要提示：不要从最初设计直接跳到最终设计中！</strong></p> <p>现在你要 1) <strong>基准测试、负载测试</strong>。2) <strong>分析、描述</strong>性能瓶颈。3) 在解决瓶颈问题的同时，评估替代方案、权衡利弊。4) 重复以上步骤。请阅读<a href="/mazx4960.github.io/system-design-primer/solutions/system_design/scaling_aws/README.html">「设计一个系统，并将其扩大到为数以百万计的 AWS 用户服务」</a> 来了解如何逐步扩大初始设计。</p> <p>讨论初始设计可能遇到的瓶颈及相关解决方案是很重要的。例如加上一个配置多台 <strong>Web 服务器</strong>的<strong>负载均衡器</strong>是否能够解决问题？<strong>CDN</strong>呢？<strong>主从复制</strong>呢？它们各自的替代方案和需要<strong>权衡</strong>的利弊又有什么呢？</p> <p>我们将会介绍一些组件来完成设计，并解决架构扩张问题。内置的负载均衡器将不做讨论以节省篇幅。</p> <p><strong>为了避免重复讨论</strong>，请参考<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%BB%E9%A2%98%E7%9A%84%E7%B4%A2%E5%BC%95">系统设计主题索引</a>相关部分来了解其要点、方案的权衡取舍以及可选的替代方案。</p> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F">DNS</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">负载均衡器</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95">水平拓展</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86web-%E6%9C%8D%E5%8A%A1%E5%99%A8">反向代理（web 服务器）</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E5%B1%82">API 服务（应用层）</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98">缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%BC%8F">一致性模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%8F%AF%E7%94%A8%E6%80%A7%E6%A8%A1%E5%BC%8F">可用性模式</a></li></ul> <h3 id="-13"><span id="-13" class="anchor"></span>将内存缓存扩大到多台机器<a href="#-13" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>为了解决庞大的请求负载以及巨大的内存需求，我们将要对架构进行水平拓展。如何在我们的<strong>内存缓存</strong>集群中存储数据呢？我们有以下三个主要可选方案：</p> <ul><li><strong>缓存集群中的每一台机器都有自己的缓存</strong> - 简单，但是它会降低缓存命中率。</li> <li><strong>缓存集群中的每一台机器都有缓存的拷贝</strong> - 简单，但是它的内存使用效率太低了。</li> <li><strong>对缓存进行<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a>，分别部署在缓存集群中的所有机器中</strong> - 更加复杂，但是它是最佳的选择。我们可以使用哈希，用查询语句 <code class="hljs inline no-lang">machine = hash(query)</code> 来确定哪台机器有需要缓存。当然我们也可以使用<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AD%A3%E5%9C%A8%E5%AE%8C%E5%96%84%E4%B8%AD">一致性哈希</a>。</li></ul> <h2 id="-14"><span id="-14" class="anchor"></span>其它要点<a href="#-14" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h2> <blockquote><p>是否深入这些额外的主题，取决于你的问题范围和剩下的时间。</p></blockquote> <h3 id="sql"><span id="sql" class="anchor"></span>SQL 缩放模式<a href="#sql" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">读取复制</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%81%94%E5%90%88">联合</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%86%E7%89%87">分片</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%9D%9E%E8%A7%84%E8%8C%83%E5%8C%96">非规范化</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%B0%83%E4%BC%98">SQL 调优</a></li></ul> <h4 id="nosql"><span id="nosql" class="anchor"></span>NoSQL<a href="#nosql" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h4> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E9%94%AE-%E5%80%BC%E5%AD%98%E5%82%A8">键-值存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%96%87%E6%A1%A3%E7%B1%BB%E5%9E%8B%E5%AD%98%E5%82%A8">文档类型存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%97%E5%9E%8B%E5%AD%98%E5%82%A8">列型存储</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93">图数据库</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#sql-%E8%BF%98%E6%98%AF-nosql">SQL vs NoSQL</a></li></ul> <h3 id="-15"><span id="-15" class="anchor"></span>缓存<a href="#-15" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>在哪缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98">客户端缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#cdn-%E7%BC%93%E5%AD%98">CDN 缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%93%E5%AD%98">Web 服务器缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98">数据库缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BA%94%E7%94%A8%E7%BC%93%E5%AD%98">应用缓存</a></li></ul></li> <li>什么需要缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9F%A5%E8%AF%A2%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">数据库查询级别的缓存</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AF%B9%E8%B1%A1%E7%BA%A7%E5%88%AB%E7%9A%84%E7%BC%93%E5%AD%98">对象级别的缓存</a></li></ul></li> <li>何时更新缓存
<ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F">缓存模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E7%9B%B4%E5%86%99%E6%A8%A1%E5%BC%8F">直写模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%9B%9E%E5%86%99%E6%A8%A1%E5%BC%8F">回写模式</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%88%B7%E6%96%B0">刷新</a></li></ul></li></ul> <h3 id="-16"><span id="-16" class="anchor"></span>异步与微服务<a href="#-16" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97">任务队列</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%83%8C%E5%8E%8B">背压</a></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a></li></ul> <h3 id="-17"><span id="-17" class="anchor"></span>通信<a href="#-17" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>可权衡选择的方案：
<ul><li>与客户端的外部通信 - <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%A1%A8%E8%BF%B0%E6%80%A7%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BBrest">使用 REST 作为 HTTP API</a></li> <li>服务器内部通信 - <a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8D%8F%E8%AE%AErpc">RPC</a></li></ul></li> <li><a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0">服务发现</a></li></ul> <h3 id="-18"><span id="-18" class="anchor"></span>安全性<a href="#-18" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>请参阅<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E5%AE%89%E5%85%A8">「安全」</a>一章。</p> <h3 id="-19"><span id="-19" class="anchor"></span>延迟数值<a href="#-19" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <p>请参阅<a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E6%AF%8F%E4%B8%AA%E7%A8%8B%E5%BA%8F%E5%91%98%E9%83%BD%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%95%B0">「每个程序员都应该知道的延迟数」</a>。</p> <h3 id="-20"><span id="-20" class="anchor"></span>持续探讨<a href="#-20" onclick="event.stopPropagation()" class="fa fa-anchor"></a></h3> <ul><li>持续进行基准测试并监控你的系统，以解决他们提出的瓶颈问题。</li> <li>架构拓展是一个迭代的过程。</li></ul> <i id="scroll-top-button" onclick="handleScrollTop()" aria-hidden="true" class="fa fa-arrow-circle-up fa-lg d-print-none"></i></div> <nav id="page-nav" class="fixed-header-padding" data-v-e8c82f88><div class="nav-component slim-scroll" data-v-e8c82f88></div> <!----></nav></div> <footer><div class="text-center"><small>[Generated by <a href="https://markbind.org/">MarkBind 3.1.1</a>]</small></div></footer></div>
</body><script src="../../../markbind/js/bootstrap-utility.min.js"></script>
<script>
  MarkBind.setupWithSearch()
</script>
</html>
